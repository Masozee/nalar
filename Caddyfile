# Caddyfile - Reverse Proxy Configuration
# Works with both domain names and direct IP access

{
    # Admin API configuration for metrics
    admin :2019
    servers {
        metrics
    }
}

# Frontend - Main Application
# Works with: domain name, localhost, or IP address
:80, {$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (only when DOMAIN is set)
    {$TLS_CONFIG}

    # Reverse proxy to Next.js frontend
    reverse_proxy frontend:3000

    # Enable compression
    encode gzip

    # Security headers
    header {
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        # Enable XSS protection
        X-XSS-Protection "1; mode=block"
        # Remove server header
        -Server
    }

    # Logging
    log {
        output stdout
        format json
        level INFO
    }
}

# Backend API - Accessible via /api path or api subdomain
# http://IP/api/* or http://api.domain.com
:80/api*, api.{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (only when DOMAIN is set)
    {$TLS_CONFIG}

    # Strip /api prefix if accessing via path
    uri strip_prefix /api

    # Reverse proxy to Django backend
    reverse_proxy backend:8000 {
        # Health check
        health_uri /health/
        health_interval 30s
        health_timeout 5s
    }

    # Enable compression
    encode gzip

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        -Server
    }

    # CORS headers
    @options {
        method OPTIONS
    }
    header @options {
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Authorization, Content-Type"
        Access-Control-Max-Age "86400"
    }
    respond @options 204

    # Logging
    log {
        output stdout
        format json
        level INFO
    }
}

# Grafana Monitoring Dashboard
# http://IP:3002 or http://grafana.domain.com
:3002, grafana.{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (only when DOMAIN is set)
    {$TLS_CONFIG}

    # Reverse proxy to Grafana
    reverse_proxy grafana:3000

    # Enable compression
    encode gzip

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        -Server
    }

    # Logging
    log {
        output stdout
        format json
        level INFO
    }
}

# Prometheus Metrics
# http://IP:9090 or http://prometheus.domain.com
:9090, prometheus.{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (only when DOMAIN is set)
    {$TLS_CONFIG}

    # Reverse proxy to Prometheus
    reverse_proxy prometheus:9090

    # Enable compression
    encode gzip

    # Logging
    log {
        output stdout
        format json
        level INFO
    }
}

# RustFS Object Storage - S3 API
s3.{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (production only)
    {$TLS_CONFIG}

    # Reverse proxy to RustFS S3 API
    reverse_proxy rustfs:9000 {
        # Increase timeouts for large file uploads
        transport http {
            read_timeout 300s
            write_timeout 300s
        }
    }

    # Enable compression (but not for binary data)
    encode gzip

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/s3-access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
        level INFO
    }
}

# RustFS Console (Web UI)
storage.{$DOMAIN:localhost} {
    # Automatic HTTPS with Let's Encrypt (production only)
    {$TLS_CONFIG}

    # Reverse proxy to RustFS Console
    reverse_proxy rustfs:9001

    # Enable compression
    encode gzip

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/storage-access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
        level INFO
    }
}

# Prometheus Metrics (Optional - usually keep internal)
# prometheus.{$DOMAIN:localhost} {
#     # Enable automatic HTTPS and basic auth for security
#     # tls {$EMAIL}
#     # basicauth {
#     #     admin {$PROMETHEUS_PASSWORD_HASH}
#     # }
#
#     reverse_proxy prometheus:9090
# }
